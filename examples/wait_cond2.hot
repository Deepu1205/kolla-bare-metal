heat_template_version: pike


parameters:

  network:
    type: string
    description: Network name
    constraints:
      - custom_constraint: neutron.network
  server_image:
    type: string
    description: Server Image (Ubuntu 16.04)
    constraints:
      - custom_constraint: glance.image
  server_flavor:
    type: string
    description: Server Flavor
    constraints:
      - custom_constraint: nova.flavor
  key_name:
    type: string
    description: Server Keypair
    constraints:
      - custom_constraint: nova.keypair

resources:
  wait_condition:
    type: OS::Heat::WaitCondition
    properties:
      handle: {get_resource: wait_handle}
      count: 1
      timeout: 300

  wait_handle:
    type: OS::Heat::WaitConditionHandle

  server1:
    type: OS::Nova::Server
    properties:
      image: { get_param: server_image }
      flavor: { get_param: server_flavor }
      security_groups: [default]
      key_name: { get_param: key_name }
      networks:
        - network: { get_param: network }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #!/bin/sh     
            localipv4=$(curl -ss http://169.254.169.254/2009-04-04/meta-data/local-ipv4)
            wc_notify --data-binary "{\"status\": \"SUCCESS\", \"data\": \"$localipv4\"}"
          params:
            wc_notify: { get_attr: [wait_handle, curl_cli] }

# second server will get the wait_condition notification

  server2:
    type: OS::Nova::Server
    properties:
      image: { get_param: server_image }
      flavor: { get_param: server_flavor }
      security_groups: [default]
      key_name: { get_param: key_name }
      networks:
        - network: { get_param: network }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            From nobody Fri Dec  9 00:31:04 2016
            Content-Type: multipart/mixed; boundary="==BOUNDARY=="
            MIME-Version: 1.0
            --==BOUNDARY==
            MIME-Version: 1.0
            Content-Type: text/x-shellscript; charset="us-ascii"
            #!/bin/bash
            echo "$wc_data" >> /tmp/data.json
            --==BOUNDARY==
            MIME-Version: 1.0
            Content-Type: text/x-include-url; charset="us-ascii"
            #include
            https://raw.githubusercontent.com/kris-at-occ/kolla-bare-metal/master/examples/wait_cond1.yml
            --==BOUNDARY==--
          params:
            wc_data: { get_attr: [wait_condition, data] }
